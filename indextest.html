<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á (‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #333; }
        
        /* Loading Overlay */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; flex-direction: column; align-items:center; justify-content:center; }
        .loader-spinner { width: 3rem; height: 3rem; }

        /* Header & Tabs */
        .header-title { font-weight: 700; color: #1a237e; letter-spacing: -0.5px; }
        .nav-pills .nav-link { border-radius: 50px; font-weight: 600; padding: 10px 25px; margin: 0 5px; color: #555; background: #e9ecef; transition: all 0.3s ease;}
        .nav-pills .nav-link.active { background: #1a237e; color: #fff; box-shadow: 0 4px 10px rgba(26,35,126,0.3); }

        /* Stat Cards */
        .card-stat { border: none; border-radius: 16px; color: white; padding: 20px; position: relative; overflow: hidden; box-shadow: 0 6px 15px rgba(0,0,0,0.08); transition: transform 0.2s;}
        .card-stat:hover { transform: translateY(-3px); }
        .card-stat h6 { font-weight: 600; opacity: 0.9; margin-bottom: 5px; font-size: 1rem;}
        .card-stat h3 { font-weight: 700; font-size: 2rem; margin-bottom: 0; }
        .card-stat small { font-size: 0.85rem; font-weight: 400; opacity: 0.85; background: rgba(0,0,0,0.15); padding: 3px 8px; border-radius: 20px; display: inline-block; margin-top: 8px;}
        .icon-bg { position: absolute; right: -10px; bottom: -15px; font-size: 5rem; opacity: 0.15; }
        
        /* Gradients */
        .bg-turnout { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .bg-good { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: #0d47a1; }
        .bg-bad { background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%); }
        .bg-no { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: #5d4037; }

        /* Ranking Section */
        .ranking-card { border: none; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .ranking-item { padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .ranking-item:last-child { border-bottom: none; }
        .progress { height: 10px; border-radius: 10px; background-color: #e9ecef; margin-top: 6px;}
        .progress-bar { border-radius: 10px; background: linear-gradient(90deg, #1a237e, #3f51b5); }

        /* DataTable Styles */
        .table-card { border: none; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        .table-responsive { max-height: 600px; }
        table.dataTable { border-collapse: collapse !important; margin-top: 0 !important; width: 100% !important; }
        table.dataTable thead th { background-color: #1a237e; color: white; text-align: center; vertical-align: middle; white-space: nowrap; font-size: 0.9rem; padding: 12px; border: 1px solid #303f9f; }
        table.dataTable tbody td { text-align: right; vertical-align: middle; font-size: 0.9rem; border: 1px solid #e0e0e0; }
        
        /* ‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà */
        table.dataTable tbody td:first-child, table.dataTable thead th:first-child { 
            position: sticky; left: 0; z-index: 2; background-color: #f8f9fa; color: #1a237e; font-weight: bold; text-align: left; box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        table.dataTable thead th:first-child { background-color: #11185a; color: white; z-index: 3;}
        .winner-cell { background-color: #e8f5e9 !important; color: #2e7d32 !important; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner-border text-primary loader-spinner" role="status"></div>
    <h4 class="mt-3 fw-bold text-primary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h4>
    <p class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets API</p>
</div>

<div class="container-fluid py-4 px-lg-5">
    
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <div>
            <h2 class="header-title mb-1"><i class="fa-solid fa-chart-pie me-2"></i>Executive Dashboard</h2>
            <p class="text-muted mb-0">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£</p>
        </div>
        <div class="mt-3 mt-md-0">
            <ul class="nav nav-pills" id="electionTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="ss-tab" data-bs-toggle="tab" data-bs-target="#ss-content" type="button" role="tab" onclick="renderView('SS')">
                        <i class="fa-solid fa-user me-1"></i> 5/18 ‡∏™‡∏™. (‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡∏ï)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pz-tab" data-bs-toggle="tab" data-bs-target="#pz-content" type="button" role="tab" onclick="renderView('PZ')">
                        <i class="fa-solid fa-users me-1"></i> 5/18 ‡∏ö‡∏ä. (‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠)
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card card-stat bg-turnout">
                <i class="fa-solid fa-users icon-bg"></i>
                <h6>‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏ô (‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥)</h6>
                <h3 id="stat-turnout">0</h3>
                <small id="stat-turnout-pct">‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 0 ‡∏Ñ‡∏ô (0%)</small>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card card-stat bg-good">
                <i class="fa-solid fa-check-circle icon-bg"></i>
                <h6>‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏µ</h6>
                <h3 id="stat-good">0</h3>
                <small id="stat-good-pct">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô 0% ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</small>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card card-stat bg-bad">
                <i class="fa-solid fa-times-circle icon-bg"></i>
                <h6>‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢</h6>
                <h3 id="stat-bad">0</h3>
                <small id="stat-bad-pct">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô 0% ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</small>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card card-stat bg-no">
                <i class="fa-solid fa-ban icon-bg"></i>
                <h6>‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏î (Vote NO)</h6>
                <h3 id="stat-no">0</h3>
                <small id="stat-no-pct">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô 0% ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</small>
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        <div class="col-xl-3 col-lg-4">
            <div class="card ranking-card h-100">
                <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                    <h5 class="fw-bold text-primary"><i class="fa-solid fa-trophy me-2 text-warning"></i>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="ranking-list">
                        </div>
                </div>
            </div>
        </div>

        <div class="col-xl-9 col-lg-8">
            <div class="card table-card h-100">
                <div class="card-header bg-white border-bottom-0 pt-4 pb-0 d-flex justify-content-between align-items-end">
                    <h5 class="fw-bold text-primary"><i class="fa-solid fa-table border-list me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</h5>
                    <span class="badge bg-success bg-opacity-10 text-success p-2"><i class="fa-solid fa-circle-info me-1"></i>‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive" id="table-container-ss">
                        <table id="dataTableSS" class="table table-hover w-100">
                            <thead id="thead-ss"></thead>
                            <tbody id="tbody-ss"></tbody>
                        </table>
                    </div>

                    <div class="table-responsive d-none" id="table-container-pz">
                        <table id="dataTablePZ" class="table table-hover w-100">
                            <thead id="thead-pz"></thead>
                            <tbody id="tbody-pz"></tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
    // URL ‡∏Ç‡∏≠‡∏á API ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet (‡∏û‡∏µ‡πà‡∏ß‡∏≤‡∏á URL ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
    const URL_SS = "https://script.google.com/macros/s/AKfycbwDKfbUED7Wqpo8L4CvjAuejif7ud5q5RJ_MTcU3uHuEsqb8ByIiLIbrSr_Hh3trTYw8w/exec";
    const URL_PZ = "https://script.google.com/macros/s/AKfycbz3EVB1uZaTBdKL6afUMa26ZV2q93EMz9JL3WEJQrRksLl8AFXS2FzOI93v9EGgxdh5FQ/exec";

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let globalData = {
        'SS': null,
        'PZ': null
    };

    $(document).ready(function() {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 2 API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
        Promise.all([
            fetch(URL_SS).then(res => res.json()),
            fetch(URL_PZ).then(res => res.json())
        ])
        .then(([rawSS, rawPZ]) => {
            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏™‡∏™. ‡πÅ‡∏•‡∏∞ ‡∏ö‡∏ä.
            globalData['SS'] = processRawData(rawSS, "‡πÄ‡∏ö‡∏≠‡∏£‡πå ");
            globalData['PZ'] = processRawData(rawPZ, "‡∏û‡∏£‡∏£‡∏Ñ ");
            
            // ‡∏õ‡∏¥‡∏î‡∏â‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î ‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ ‡∏™‡∏™.
            $('#loading-overlay').fadeOut();
            renderView('SS');
        })
        .catch(err => {
            $('#loading-overlay').html(`<div class="text-danger text-center"><h4><i class="fa-solid fa-triangle-exclamation"></i> ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h4><p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ<br>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Anyone)</p></div>`);
            console.error("Fetch error:", err);
        });
    });

    /**
     * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å Array of Arrays ‡πÄ‡∏õ‡πá‡∏ô Object ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
     * ‡πÅ‡∏ñ‡∏ß 0: ‡∏´‡∏ô‡πà‡∏ß‡∏¢, 1: ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥, 2: ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏ô, 3: ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£, 4: ‡πÉ‡∏ä‡πâ, 5: ‡∏î‡∏µ, 6: ‡πÄ‡∏™‡∏µ‡∏¢, 7: ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å, 8: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠
     * ‡πÅ‡∏ñ‡∏ß 9 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A(index 0) = ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡∏û‡∏£‡∏£‡∏Ñ, ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ = ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢
     */
    function processRawData(raw, prefixLabel) {
        const numCols = raw[0].length;
        let totals = { eligible:0, turnout:0, allotted:0, used:0, good:0, bad:0, noVote:0, remain:0 };
        let stations = [];
        let candidates = [];

        // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 9 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ)
        for(let i=9; i<raw.length; i++) {
            let cName = raw[i][0];
            if(!cName) continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏â‡∏¢‡πÜ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏ö‡∏≠‡∏£‡πå 1" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏û‡∏£‡∏£‡∏Ñ 1" ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡πÜ
            let displayName = isNaN(cName) ? cName : prefixLabel + cName;
            candidates.push({ originalRowIndex: i, name: displayName, totalScore: 0 });
        }

        // 2. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 1 ‡∏´‡∏£‡∏∑‡∏≠ B2 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á)
        for(let c=1; c<numCols; c++) {
            let stName = raw[0][c];
            if(!stName) continue;

            let st = {
                name: stName,
                eligible: parseInt(raw[1][c]) || 0,
                turnout: parseInt(raw[2][c]) || 0,
                allotted: parseInt(raw[3][c]) || 0,
                used: parseInt(raw[4][c]) || 0,
                good: parseInt(raw[5][c]) || 0,
                bad: parseInt(raw[6][c]) || 0,
                noVote: parseInt(raw[7][c]) || 0,
                remain: parseInt(raw[8][c]) || 0,
                scores: []
            };

            // ‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏Ç‡∏ï
            totals.eligible += st.eligible;
            totals.turnout += st.turnout;
            totals.allotted += st.allotted;
            totals.used += st.used;
            totals.good += st.good;
            totals.bad += st.bad;
            totals.noVote += st.noVote;
            totals.remain += st.remain;

            // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏µ‡πâ
            candidates.forEach((cand, idx) => {
                let s = parseInt(raw[cand.originalRowIndex][c]) || 0;
                st.scores.push(s);
                candidates[idx].totalScore += s; // ‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
            });

            stations.push(st);
        }

        // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞
        let ranked = [...candidates].sort((a,b) => b.totalScore - a.totalScore);

        return { totals, stations, candidates, ranked };
    }

    /**
     * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏™‡∏™. ‡πÅ‡∏•‡∏∞ ‡∏ö‡∏ä.
     */
    let dtTableSS = null;
    let dtTablePZ = null;

    function renderView(type) {
        const data = globalData[type];
        if(!data) return;

        // ‡∏™‡∏•‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        if(type === 'SS') {
            $('#table-container-ss').removeClass('d-none');
            $('#table-container-pz').addClass('d-none');
        } else {
            $('#table-container-pz').removeClass('d-none');
            $('#table-container-ss').addClass('d-none');
        }

        // --- 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Stat Cards ---
        const t = data.totals;
        const calcPct = (val, total) => total > 0 ? ((val/total)*100).toFixed(2) : 0;

        $('#stat-turnout').text(t.turnout.toLocaleString());
        $('#stat-turnout-pct').text(`‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${t.eligible.toLocaleString()} ‡∏Ñ‡∏ô (${calcPct(t.turnout, t.eligible)}%)`);
        
        $('#stat-good').text(t.good.toLocaleString());
        $('#stat-good-pct').text(`‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô ${calcPct(t.good, t.turnout)}% ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥`);

        $('#stat-bad').text(t.bad.toLocaleString());
        $('#stat-bad-pct').text(`‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô ${calcPct(t.bad, t.turnout)}% ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥`);

        $('#stat-no').text(t.noVote.toLocaleString());
        $('#stat-no-pct').text(`‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô ${calcPct(t.noVote, t.turnout)}% ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥`);


        // --- 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Ranking List ---
        const rankingHtml = data.ranked.map((c, index) => {
            let maxScore = data.ranked[0].totalScore || 1; // ‡∏Å‡∏±‡∏ô‡∏´‡∏≤‡∏£ 0
            let pct = (c.totalScore / maxScore) * 100;
            
            // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ñ‡πâ‡∏ß‡∏¢‡∏ó‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà 1
            let medal = index === 0 ? '<i class="fa-solid fa-medal text-warning ms-2"></i>' : '';
            // ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‡πÉ‡∏´‡πâ Top 3
            let rankNumClass = index < 3 ? 'bg-primary text-white' : 'bg-light text-secondary border';

            return `
            <div class="ranking-item">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="fw-bold text-truncate" style="max-width:70%;">
                        <span class="badge ${rankNumClass} rounded-circle me-2" style="width:24px;height:24px;padding:5px 0;">${index+1}</span>
                        ${c.name} ${medal}
                    </div>
                    <div class="fw-bold text-primary">${c.totalScore.toLocaleString()}</div>
                </div>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped ${index === 0 ? 'progress-bar-animated' : ''}" style="width: ${pct}%"></div>
                </div>
            </div>`;
        }).join('');
        $('#ranking-list').html(rankingHtml);


        // --- 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DataTable ---
        const tableId = type === 'SS' ? '#dataTableSS' : '#dataTablePZ';
        const theadId = type === 'SS' ? '#thead-ss' : '#thead-pz';
        const tbodyId = type === 'SS' ? '#tbody-ss' : '#tbody-pz';
        
        let dtInstance = type === 'SS' ? dtTableSS : dtTablePZ;

        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á Table ‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        if (!dtInstance) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Header
            let headHtml = `<tr>
                <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</th><th>‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</th><th>‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</th>
                <th>‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£</th><th>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</th><th>‡∏î‡∏µ</th><th>‡πÄ‡∏™‡∏µ‡∏¢</th><th>No</th><th>‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>`;
            data.candidates.forEach(c => { headHtml += `<th>${c.name}</th>`; });
            headHtml += `</tr>`;
            $(theadId).html(headHtml);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Body
            let bodyHtml = '';
            data.stations.forEach(st => {
                const maxScore = Math.max(...st.scores);
                bodyHtml += `<tr>
                    <td>${st.name}</td>
                    <td>${st.eligible.toLocaleString()}</td>
                    <td class="text-primary fw-bold">${st.turnout.toLocaleString()}</td>
                    <td>${st.allotted.toLocaleString()}</td>
                    <td>${st.used.toLocaleString()}</td>
                    <td class="text-success">${st.good.toLocaleString()}</td>
                    <td class="text-danger">${st.bad.toLocaleString()}</td>
                    <td class="text-secondary">${st.noVote.toLocaleString()}</td>
                    <td>${st.remain.toLocaleString()}</td>`;
                
                st.scores.forEach(s => {
                    let isWinner = (s === maxScore && s > 0) ? 'winner-cell' : '';
                    bodyHtml += `<td class="${isWinner}">${s.toLocaleString()}</td>`;
                });
                bodyHtml += `</tr>`;
            });
            $(tbodyId).html(bodyHtml);

            // Initialize DataTable
            dtInstance = $(tableId).DataTable({
                "scrollX": true,
                "pageLength": 10,
                "language": {
                    "search": "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢:",
                    "lengthMenu": "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
                    "info": "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡∏´‡∏ô‡πà‡∏ß‡∏¢",
                    "paginate": { "next": "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", "previous": "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤" }
                }
            });

            // ‡πÄ‡∏Å‡πá‡∏ö instance ‡πÑ‡∏ß‡πâ
            if(type === 'SS') dtTableSS = dtInstance;
            else dtTablePZ = dtInstance;

        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Ñ‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏Ñ‡πà Adjust ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏π‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Tab
            setTimeout(() => { dtInstance.columns.adjust().draw(); }, 10);
        }
    }
</script>
</body>
</html>